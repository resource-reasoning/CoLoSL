\begin{lemma}[\shiftRule-Fence]\label{lem:shift-fence}
For all $\lmod_1, \lmod_2 \in \AMods$, $s, s', r \in \LStates$ and $a \in \m{rg}(\lmod_1)$:
%
\[
	\lmod_1 \weakenI{\{s\}} \lmod_2 /| \left(s' \in a(s) \lor (s', -) \in a[s, r] \right) \implies \lmod_1 \weakenI{\{s'\}} \lmod_2
\]
%
\begin{proof}
Pick an arbitrary $\lmod_1, \lmod_2 \in \AMods$, $s, s', r \in \LStates$ and $a \in \m{rg}(\lmod_1)$ such that:
%
\begin{align}
	\lmod_1 \weakenI{\{s\}} \lmod_2 \label{LMS:Ass1}
\end{align}
%(\ref{LMS:Ass})
\textbf{RTS. } $\lmod_1 \weakenI{\{s'\}} \lmod_2$.\\
There are two cases to consider:\\
\textbf{Case 1. }$s' \in a(s)$\\
From the definition of $\weakenI{\{s\}}$ and (\ref{LMS:Ass1}) we know there exists a fence $\fence{}$ such that:
%
\begin{align}
	& s \in \fence{} \label{LMS:Ass3}\\
	& \fence{} \fences \lmod_1 \label{LMS:Ass4}\\
	\for{l \in \fence{}} \for{\ca{}}& \for{a \in \lmod_2(\ca{})} \m{reflected}(a, l, \lmod_1(\ca{})) /| \null \nonumber\\
	& \for{a \in \lmod_1(\ca{})} a(l) \text{ is defined } /| \m{visible}(a, l) \implies \m{reflected}(a, l, \lmod_2(\ca{})) \label{LMS:Ass5}
\end{align}
%(\ref{LMS:Ass})
By definition of $\fences$ and from (\ref{LMS:Ass3})-(\ref{LMS:Ass4}) and assumption of case 1. we have: 
%
\begin{align}
	& s' \in \fence{} \label{LMS:Ass6}
\end{align}
%
Finally by definition of $\weakenI{\{s'\}}$ and (\ref{LMS:Ass4})-(\ref{LMS:Ass6}) we have
%
\begin{align*}
	\lmod_1 \weakenI{\{s'\}} \lmod_2
\end{align*}
%
as required.\\

\noindent\textbf{Case 2. }$(s', -) \in a[s, r]$\\
%From the definition of $a[s, r]$ we know :
%\begin{align*}
%	(s' = s ) |/ 
%	\left(
%	\begin{array}{@{}l l@{}}
%		\exsts{p_s ? \unitL}\exsts{p_r, s'', r''} & s = p_s \composeL s''\\
%		& r = p_r \composeL r'' \\
%		& \fst{\updateFP{a}} = p_s \composeL p_r \\
%		& s' = \snd{\updateFP{a}} \composeL s'' \\
%		& s' \composeL r'' \text{ is defined}
%	\end{array} 
%	\right)	
%\end{align*}
%
From the definitions of $a[s, r]$ and $a(s)$ and from the assumption of the case we know $s' \in a(s)$. The rest of the proof is identical to that of case 1.
\end{proof}
\end{lemma}
%
%
%
\begin{lemma}[\shiftRule-Closure-1]\label{lem:shift-closure}
%
For all $\lmod_1, \lmod_2, \lmod \in \AMods$ and $s, r \in \LStates$,
%
\[
	\extendsAM{\lmod}{s}{r}{\lmod_1} /| \lmod_1 \weakenI{\{s\}} \lmod_2 \implies \extendsAM{\lmod}{s}{r}{\lmod_2}
\]
%
\begin{proof} Pick an arbitrary $\lmod_1, \lmod_2, \lmod \in \AMods$ and $s, r \in \LStates$ such that 
%
\begin{align}
	& \extendsAM{\lmod}{s}{r}{\lmod_1} \label{SC:Ass1}\\
	& \lmod_1 \weakenI{\{s\}} \lmod_2 \label{SC:Ass2}
\end{align} 
%
From the definition of $\downarrow$, it then suffices to show
%
\begin{align}
	& \for {n \in \Nats}  \isContainedAM{\lmod_2}{n}{s \composeL r}{\lmod} \label{SC:Goal1}\\
	& \for {n \in \Nats}  \extendsAMUpto{\lmod}{n}{s}{r}{\lmod_2} \label{SC:Goal2}
\end{align}
%
\noindent\textbf{RTS. (\ref{SC:Goal1})} \\
Rather than proving (\ref{SC:Goal1}) directly, we first establish the following.
%
\begin{align}
	& \for {n \in \Nats} \for{s, r \in \LStates} \nonumber\\
	& \quad \isContainedAM{\lmod_1}{n}{s \composeL r}{\lmod} /| \lmod_1 \weakenI{\{s\}} \lmod_2 \implies \isContainedAM{\lmod_2}{n}{s \composeL r}{\lmod} \label{SCG1:Goal3}
\end{align}
%
We can then despatch (\ref{SC:Goal1}) from (\ref{SC:Ass1}), (\ref{SC:Ass2}) and (\ref{SCG1:Goal3}); since for an arbitrary $n \in \Nats$, from (\ref{SC:Ass1}) and the definition of $\leq$ we have $\isContainedAM{\lmod_1}{n}{s \composeL r}{\lmod}$ and consequently from (\ref{SC:Ass2}) and (\ref{SCG1:Goal3}) we derive $\isContainedAM{\lmod_2}{n}{s \composeL r}{\lmod} $ as required. \\

\noindent\textbf{RTS. (\ref{SCG1:Goal3})} \\
We proceed by induction on the number of steps $n$.\\

%\noindent Pick an arbitrary $s_1, s_2, r \in \LStates, \lmod, \lmod', \gmod \in \AMods$.\\
\noindent\textbf{Base case }$n=0$\\
Pick an arbitrary $s, r \in \LStates$. We are then required to show	$\isContainedAM{\lmod_2}{0}{s \composeL r}{\lmod} $ which follows trivially from the definition of $\leq_0$.\\


\noindent\textbf{Inductive Case}\\
Pick an arbitrary $s, r \in \LStates$ such that:
\begin{align}
	&\isContainedAM{\lmod_1}{n}{s \composeL r}{\lmod} \label{LSCG1:Ass1}\\
	&\lmod_1 \weakenI{\{s\}} \lmod_2 \label{LSCG1:Ass2}\\
%		
	&	\for{s, r \in \LStates}  \nonumber\\
	& \tag{I.H} 
		\quad \isContainedAM{\lmod_1}{(n-1)}{s \composeL r}{\lmod} /| \lmod_1 \weakenI{\{s\}} \lmod_2 \implies \isContainedAM{\lmod_2}{(n-1)}{s \composeL r}{\lmod} \label{LSCG1:IH}
\end{align}
%
\textbf{RTS. } 
%
\begin{align}
  &\V{\ca{}}\V{a\in \lmod_2(\ca{})}
		\m{reflected}(a,s \composeL r, \lmod(\ca{})) /| \isContainedAM{\lmod_2}{(n-1)}{a[s \composeL r]}{\lmod} \label{LSCG1:Goal3}
\end{align}
%
Pick an arbitrary $\ca{}$, $a$ and $p, c, q\in \LStates$ such that:
%
\begin{align}
	a = (p, q, c) \in \lmod_2(\ca{}) \label{LSCG1:Ass8}
\end{align}
%
Pick an arbitrary $l \in \LStates$ such that:
%
\begin{align}
	p \composeL c \leq s \composeL r \composeL l \label{LSCG1:Ass9}
\end{align}
%
From (\ref{LSCG1:Ass2}) and (\ref{LSCG1:Ass8}) we have $\m{reflected}(a, s, \lmod_1)$ and consequently by definition of $\m{reflected}$ and (\ref{LSCG1:Ass9}) we know there exists $a''$ and $c''$ such that 
%
\begin{align}
	a'' = (p, c'', q) \land a'' \in \lmod_1(\ca{}) \land p \composeL c'' \leq s \composeL r \composeL l \label{LSCG1:Ass10}
\end{align}
%
On the other hand from (\ref{LSCG1:Ass1}) and the definition of $\leq_n$ we know there exists $c'$ and $a'$ such that:
%
\begin{align}
	& a' = (p, c', q) \land a' \in \lmod(\ca{}) \land p \composeL c' \leq s \composeL r \composeL l \label{LSCG1:Ass11}\\
	& \isContainedAM{\lmod_1}{(n-1)}{a''[s \composeL r]}{\lmod} \label{LSCG1:Ass12}
\end{align}
%
Consequently from (\ref{LSCG1:Ass9}) and (\ref{LSCG1:Ass11}) we have:
%
\begin{align*}
	\m{reflected}(a, s \composeL r, \lmod(\ca{})
\end{align*}
% 
If $a[s \composeL r]$ is undefined then we trivially have $\isContainedAM{\lmod_2}{(n-1)}{a[s \composeL r]}{\lmod}$ as required. On the other hand if $a[s \composeL r]$ is defined then from (\ref{LSCG1:Ass10}) and the definition of $a[s \composeL r]$ we know there exists $s', r' \in \LStates$ such that  
%
\begin{align}
	& a[s \composeL r] = a''[s \composeL r] = a'[s \composeL r] \label{LSCG1:Ass13} \\
	& (s', r') \in a''[s, r] \land  s' \composeL r' = a''[s \composeL r] \label{LSCG1:Ass14}
\end{align}
%
and consequently from (\ref{LSCG1:Ass12}) and (\ref{LSCG1:Ass13}) we have
%
\begin{align}
	\isContainedAM{\lmod_1}{(n-1)}{a[s \composeL r]}{\lmod} \label{LSCG1:Ass15}
\end{align}
%
From (\ref{LSCG1:Ass2}),  (\ref{LSCG1:Ass14}) and \lem~\ref{lem:shift-fence} we have 
%
\begin{align}
	\lmod_1 \weakenI{\{s'\}} \lmod_2 \label{LSCG1:Ass16}
\end{align}
%
Consequently from (\ref{LSCG1:Ass13})-(\ref{LSCG1:Ass16}) and (\ref{LSCG1:IH}) we have
%
\begin{align*}
	\isContainedAM{\lmod_2}{(n-1)}{a[s \composeL r]}{\lmod}
\end{align*}
%
as required.\\
%
%
%
%

\noindent\textbf{RTS. (\ref{SC:Goal2})} \\
Rather than proving (\ref{SC:Goal2}) directly, we first establish the following.
%
\begin{align}
	& \for {n \in \Nats} \for{s, r \in \LStates} \nonumber\\
	& \quad \extendsAMUpto{\lmod}{n}{s}{r}{\lmod_1} /| \lmod_1 \weakenI{\{s\}} \lmod_2 \implies \extendsAMUpto{\lmod}{n}{s}{r}{\lmod_2} \label{SC:Goal3}
\end{align}
%
We can then despatch (\ref{SC:Goal2}) from (\ref{SC:Ass1}), (\ref{SC:Ass2}) and (\ref{SC:Goal3}); since for an arbitrary $n \in \Nats$, from (\ref{SC:Ass1}) and the definition of $\downarrow$ we have $\extendsAMUpto{\lmod}{n}{s}{r}{\lmod_1}$ and consequently from (\ref{SC:Ass2}) and (\ref{SC:Goal3}) we derive $\extendsAMUpto{\lmod}{n}{s}{r}{\lmod_2} $ as required. \\

\noindent\textbf{RTS. (\ref{SC:Goal3})} \\
We proceed by induction on the number of steps $n$.\\

%\noindent Pick an arbitrary $s_1, s_2, r \in \LStates, \lmod, \lmod', \gmod \in \AMods$.\\
\noindent\textbf{Base case }$n=0$\\
Pick an arbitrary $s, r \in \LStates$. We are then required to show	$\extendsAMUpto{\lmod}{0}{s}{r}{\lmod_2} $ which follows trivially from the definition of $\downarrow_0$.\\


\noindent\textbf{Inductive Case}\\
Pick an arbitrary $s, r \in \LStates$ such that:
\begin{align}
	&\extendsAMUpto{\lmod}{n}{s}{r}{\lmod_1} \label{LSC:Ass1}\\
	&\lmod_1 \weakenI{\{s\}} \lmod_2 \label{LSC:Ass2}\\
%		
	&	\for{s, r \in \LStates}  \nonumber\\
	& \tag{I.H} 
		\quad \extendsAMUpto{\lmod}{(n-1)}{s}{r}{\lmod_1} /| \lmod_1 \weakenI{\{s\}} \lmod_2 \implies \extendsAMUpto{\lmod}{(n-1)}{s}{r}{\lmod_2} \label{LSC:IH}
\end{align}
%
\textbf{RTS. } 
%
\begin{align}
%	& 
%	\V{\ca{}}  \V{a\in \lmod_2(\ca{})} \nonumber \\
%  &\quad (\m{potential}(a,s \composeL r) => \nonumber\\
%  & \quad\qquad\for{(s', r') \in a[s, r]} \extendsAMUpto{\lmod \cup \lmod_2, \gmod}{(n-1)}{s'}{r'}{\lmod_2}) \label{LSC:Goal1} /| \\
%%   
%  &\quad (\m{enabled}(a,s \composeL r)
%  => (s\composeL r, a[s \composeL r])\in \gmod(\ca{}))
%  /|\null \label{LSC:Goal2}\\
%%  
  &\V{\ca{}}\V{a\in \lmod (\ca{})}
  \m{potential}(a,s \composeL r) =>\null \nonumber \\
  & \quad
  \begin{array}{@{} l @{}}
		\left(\m{reflected}(a,s \composeL r, \lmod_2(\ca{})) |/ \neg\m{visible}(a,s) \ \right) /| \\
		\for{(s', r') \in a[s, r]} \extendsAMUpto{\lmod}{(n-1)}{s'}{r'}{\lmod_2}
 	\end{array} \label{LSC:Goal3}
\end{align}
%
Pick an arbitrary $\ca{}$ and $a = (p, q, c) \in \lmod(\ca{})$ such that:
%
\begin{align}
	\m{potential}(a, s \composeL r)\label{LSC:Ass8}
\end{align}
%
%If $a \in \lmod_2 (\ca{})$, then it is trivially the case that $\m{reflected}(a, s \composeL r, \lmod_2(\ca{}))$. 
From (\ref{LSC:Ass1}) and (\ref{LSC:Ass8}) we have:
%
\begin{align}
	& \begin{array}{@{} l @{}}
		\left(\m{reflected}(a, s \composeL r, \lmod_1(\ca{})) |/ \neg\m{visible}(a, s) \ \right) /| \\
		\for{(s', r') \in a[s, r]} \extendsAMUpto{\lmod}{(n-1)}{s'}{r'}{\lmod_1}
	\end{array}
	\label{LSC:Ass20}
\end{align}
%
Pick an arbitrary $(s', r')$ such that 
%
\begin{align}
	(s', r') \in a[s, r] \label{LSC:Ass21}
\end{align}
%
Then from (\ref{LSC:Ass20}) we have:
%
\begin{align}
	\extendsAMUpto{\lmod}{(n-1)}{s'}{r'}{\lmod_1}
	\label{LSC:Ass22}
\end{align}
%
On the other hand, from (\ref{LSC:Ass21}) and \lem~\ref{lem:shift-fence} we have:
%
\begin{align}
	\lmod_1 \weakenI{\{s'\}} \lmod_2 
	\label{LSC:Ass23}
\end{align}
%
Consequently, from (\ref{LSC:Ass22}), (\ref{LSC:Ass23}) and (\ref{LSC:IH}) we have:
%
\begin{align*}
	\extendsAMUpto{\lmod}{(n-1)}{s'}{r'}{\lmod_2}
\end{align*}
%
and thus from (\ref{LSC:Ass21}) we have
%
\begin{align}
	\for{(s', r') \in a[s, r]} \extendsAMUpto{\lmod}{(n-1)}{s'}{r'}{\lmod_2}
	\label{LSC:Ass24}
\end{align}
%
Since either $\m{visible}(a, s)$ or $\neg\m{visible}(a, s)$, there are two cases to consider:\\

\noindent\textbf{Case 1. } $ \neg \m{visible}(a, s)$\\
From the assumption of case 1 and (\ref{LSC:Ass24}) we then have
%
\begin{align*}
	& \neg\m{visible}(a, s) /| \\
	&\for{(s', r') \in a[s, r]} \extendsAMUpto{\lmod}{(n-1)}{s'}{r'}{\lmod_2}
\end{align*}
%
as required.\\
%
%
%
%

\noindent\textbf{Case 2. } $\m{visible}(a, s)$\\
From (\ref{LSC:Ass20}) and the assumption of case 2 we then have
%
\begin{align}
	\m{reflected}(a, s \composeL r, \lmod_1(\ca{}))
	\label{LSC:Ass25}
\end{align}
%
Pick an arbitrary $l \in \LStates$ such that:
%
\begin{align}
	p \composeL c \leq s \composeL r \composeL l \label{LSC:Ass9}
\end{align}
%
Then from (\ref{LSC:Ass25}) and the definition of $\m{reflected}$ we have:
%(\ref{LSC:Ass})
\begin{align}
	\exsts{a', c'} a' = (p, q, c') \land a' \in \lmod_1(\ca{}) \land  p \composeL c' \leq s \composeL r \composeL l \label{LSC:Ass10}
\end{align}
%(\ref{LSC:Ass})
From (\ref{LSC:Ass8}) and by definition of $\m{potential}$ we know $a[s \composeL r]$ is defined; from (\ref{LSC:Ass10}), and the definition of $a'[s \composeL r]$ we know that $a'[s \composeL r]$ is also defined. Consequently, from the definition of $a'(s)$, we know $a'(s)$ is also defined. Thus, from the definition of $\m{visible}$, (\ref{LSC:Ass10}) and the assumption of case 1.2 we have 
%
\begin{align}
	\m{visible}(a', s)
	\label{LSC:Ass26}
\end{align}
%
Thus from (\ref{LSC:Ass2}), (\ref{LSC:Ass10}), (\ref{LSC:Ass26}) and from the definition of $\weakenI{\{s\}}$ we have 
%
\begin{align}
	\exsts{a'', c''} a'' = (p, q, c'') \land a'' \in \lmod_2(\ca{}) \land  p \composeL c'' \leq s \composeL r \composeL l  \label{LSC:Ass11}
\end{align} 
%
Finally, from (\ref{LSC:Ass9}), (\ref{LSC:Ass10}), (\ref{LSC:Ass11}) and by definition of $\m{reflected}$ we have:
%
\begin{align}
	\m{reflected}(a, s \composeL r, \lmod_2(\ca{}))
	\label{LSC:Ass27}
\end{align} 
%
From (\ref{LSC:Ass24}) and (\ref{LSC:Ass27}) we have
\begin{align*}
	&\m{reflected}(a, s \composeL r, \lmod_2(\ca{})) /| \\
	&\for{(s', r') \in a[s, r]} \extendsAMUpto{\lmod}{(n-1)}{s'}{r'}{\lmod_2}
\end{align*}
%
as required.\\
%(\ref{LSC:Ass})
%
%
%
%

\end{proof}
\end{lemma}
%
%
%
%
%
%

\begin{lemma}[action-application]\label{lem:action-application}
%
For all $a \in \LStates \times \LStates \times \LStates$ and $s_1$ , $r_1$, $s_2$, $r_2$, $s'_1$, $r'_1$, $s'_2$, $r'_2 \in \LStates$,
\[
	s_1 \composeL r_1 = s_2 \composeL r_2 /| (s'_1, r'_1) \in a[s_1, r_1] /| (s'_2, r'_2) \in a[s_2, r_2] \implies s'_1 \composeL r'_1 = s'_2 \composeL r'_2 
\]
%
\begin{proof}
Take arbitrary $a \in \LStates \times \LStates \times \LStates$ and $s_1$ , $r_1$, $s_2$, $r_2$, $s'_1$, $r'_1$, $s'_2$, $r'_2 \in \LStates$ such that 
%
\begin{align}
	& s_1 \composeL r_1 = s_2 \composeL r_2 \label{LAA:Ass1}\\
	& (s'_1, r'_1) \in a[s_1, r_1] \label{LAA:Ass2}\\
	& (s'_2, r'_2) \in a[s_2, r_2] \label{LAA:Ass3}
\end{align}
%
Then from (\ref{LAA:Ass2}), and the definitions of $a[s_1, r_1]$ and $a[s_1 \composeL r_1]$ we have:
%
\begin{align}
	a[s_1 \composeL r_1] = s'_1 \composeL r'_1 \label{LAA:Ass4}
\end{align}
%
Similarly, from (\ref{LAA:Ass3}) we have:
%
\begin{align}
	a[s_2 \composeL r_2] = s'_2 \composeL r'_2 \label{LAA:Ass5}
\end{align}
%
Finally, from (\ref{LAA:Ass1}), (\ref{LAA:Ass4}) and (\ref{LAA:Ass5}) we have:
%
\begin{align*}
	s'_1 \composeL r'_1 = s'_2 \composeL r'_2 
\end{align*}
%
as required.
\end{proof}
%
\end{lemma}
%
%
