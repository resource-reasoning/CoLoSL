\section{\colosl worlds and assertions}
\label{sec:logic}

In this section, we formally introduce the assertion language of
\colosl and their models. We start with the latter.

\subsection{Worlds}

\paragraph{Overview}
%% Incomplete, subjective view of the shared state forces us to revisit many
%% semantic concepts related to shared resources and interference.
%%  In doing so, we find that, although we pay a price of subtlety for
%% some definitions, our more general setting makes for cleaner
%% definitions (TODO: not good; not sure what I want to say here,
%% something like ``because we have to be more general, we cannot
%% weasel out of some difficulties, but that actually makes the
%% setting simpler in some respects, eg no token games, ability to
%% manipulate the interference relations, etc.'').
In this section, we gradually introduce the
semantic model of \emph{worlds}, our representation of program
states in the logic.

A \emph{world} is a 4-tuple $(l,g,\lmod,\gmod)$ where $l$ and $g$
are \emph{logical states} and $\lmod$ and $\gmod$ are \emph{action
  models}; let us explain the role of each component informally. The
\emph{local (logical) state} $l$ represents the locally owned
resources of a thread (\textit{e.g.} the capability $\{\token a_{\li
  y}\}$ for $\mathbb{P}_{\li y}$ in the previous section). The
\emph{shared (logical) state} $g$ represents the \emph{whole}
current shared state, and is subject to interferences as described by
the action models.

An action model is a partial function from \emph{capabilities} to sets
of \emph{actions}. An action is a pair $(p,q)$ of logical states
where $p$ is the \emph{pre-state} of the action and $q$ its
\emph{post-state}.  The \emph{local action model} $\lmod$
corresponds directly to the (semantic interpretations of) interference
relations $I$, as we have used in the example above. The \emph{global
  action model} $\gmod$ extrapolates the effect of the actions in
$\lmod$ to the global shared state $g$. Although worlds do not put
further constraints on the relationship between $\lmod$ and $\gmod$,
they will be linked more tightly in the semantics of assertions (see
\S\ref{sec:assertions}).

As $g$ represents the global shared state, we will also require that
actions in $\lmod$ are \emph{confined} to $g$ (which we write $g
\containI \lmod$, \textit{i.e.} the part of state they mutate is
always fully contained in $g$. Thus, these actions cannot affect new
pieces of global state $g'$ disjoint from $g$. This is essential to
enable extensions of the shared state. We will similarly require that
new actions in any extension are confined to that extension in the
same sense.

Finally, the composition of two worlds will be defined whenever their
local states are disjoint and they agree on all other three
components, hence have identical knowledge of the shared state and
possible interferences.

\paragraph{Worlds and actions}
We start by defining logical states, which are \colosl's central
concept of \emph{resources}, in the standard separation logic
sense. Logical states have two components: one describes machine
states; the other represents \emph{capabilities}. The latter are
inspired by the same notion in deny-guarantee reasoning~\cite{dg}: a
thread in possession of a given capability is allowed to perform the
associated actions (as prescribed by the \emph{action model}
components of each world, defined below), while any capability
\emph{not} owned by a thread means that the environment can perform
the action.\footnote{In general, capabilities could be fractionally
  owned, in which case ownership of a \emph{fraction} of a capability
  grants the right to perform the action to both the thread and the
  environment, while a fully-owned capability \emph{denies} the right
  to the environment to perform the associated action. For ease of
  exposition, we only consider the case of fully-owned capabilities in
  our formal development. See the long version for the general case.}
Action models interpret interference assertions and assign actions to
capabilities.

\begin{definition}[Logical states]
  A \emph{logical state} is a tuple $((@s, h), \ca{})$, also written
  $(@s,h,\ca{})$, of a finite partial \emph{stack} $@s\in\set{Stack}$
  associating program variables with values, a heap $h \in \set{Heap}$
  associating heap locations with values, and a capability $\ca{}
  \in\Caps$.
  \begin{mathpar}
    \set{Stack} == \set{PVar} --`_{\m{fin}} \set{Val}

    \set{Heap} == \set{Loc} --`_{\m{fin}} \set{Val}

    \Heaps == \set{Stack}\times \set{Heap}

    \Caps == \powerset(\set{Token})

    \LStates == \Heaps\times \Caps
  \end{mathpar}
  We write $\unitL$ for the logical state $(\emptyset, \unitH,
  \unitCap)$. The \emph{composition of logical states} $ \composeL :
  \LStates \times \LStates \rightharpoonup \LStates $ is defined as
  the disjoint union $\uplus$ of their individual components:
  \[
  (@s, h,\ca{}) \composeL (@s', h', \ca{}') \eqdef
  (@s\uplus @s', h\composeH h', \ca{}\composeCap \ca{}')
  \]
\end{definition}
Although, for this presentation, we build logical states from a fixed
$\Heaps$ and $\Caps$, the general setting allows these two objects to
be instantiated with \emph{any} separation algebras (\textit{i.e.}
cancellative partial commutative monoids~\cite{asl}) satisfying a
technical \emph{cross-split} condition~\cite{colosl-tr14}.

In the following, we write $l_1\leq l_2$ when there exists $l$ such
that $l\composeL l_1 = l_2$. When that is the case, we also write $l_2
- l_1$ to denote the unique (by cancellativity) such $l$. When $l_1$
and $l_2$ are compatible according to $\composeL$, we write
$l_1\compatL l_2$.

An action is simply a pair of logical states describing the pre and
post-states of the action, and an action model describes the set of
actions enabled by each capability.

\begin{definition}[Action]
  An action $a\in\set{Action}$ is a pair of logical states:
  \[
  \set{Action} == \LStates \times \LStates
  \]
\end{definition}

\begin{definition}[Action models]
An \emph{action model} is a partial function from capabilities to
actions:
\[
\lmod \in \AMods \eqdef \Caps \rightharpoonup \pset{\set{Action}}
\]
We write $\unitAM$ for an action model with empty domain.
\end{definition}


\paragraph{The effect of actions} As mentioned in the beginning of the
section, we require that actions in the local and global action models
are \emph{confined} to the global shared state.  Let us now introduce
the necessary machinery to describe how actions in $\lmod$ and $\gmod$
act on the shared state $g$, which will allow us to define our
confinement condition, and then the set of well-formed worlds.

\begin{definition}[Intersection]
The \emph{intersection} function over logical states 
$
\meetL : \left(\LStates \times \LStates \right) \rightarrow \pset{\LStates}
$
is defined as:
\[
l_1 \meetL l_2 \eqdef 
\left\{ 
l  \mid
\exsts{l', l_1', l_2'}\! l_1 = l \composeL l_1' \land l_2 = l \composeL l_2' \land l \composeL l_1' \composeL l_2' = l'
\right\}
\]
%% The \emph{maximal intersection} $l_1 \maxMeetL l_2$ of $l_1$ and $l_2$
%% is defined as the largest element of the intersection of $l_1$ and
%% $l_2$, when it exists.
\end{definition}

%% One can check that $l_1\maxMeetL l_2$ indeed yields at most one
%% element for any given $l_1$ and $l_2$~\cite{colosl-tr14}.
One can check that $l_1\meetL l_2$ yields at most one element for any
given $l_1$ and $l_2$~\cite{colosl-tr14}. Thus, we will usually omit
the set notation.\footnote{In the general case, separation algebras
  may lack the \emph{disjointness} property, in which case
  intersection between two states may yield more than one state. Thus,
  our general definition introduces \emph{maximal intersections} to
  restore unicity. Since our logical states satisfy disjointness,
  intersection is enough for our exposition.}

An action $a = (p, q)$ is typically of the form $(p'\composeL c,
q'\composeL c)$, \textit{i.e.} part of the state $c$ required for
the action is \emph{passive} and acts as a mere \emph{catalyst} for
the action: it has to be present for the action to take effect, but is
left unchanged by the action. The \emph{active} of the action is then
the pair $(p',q')$, which should be maximal in the sense that no
further, non-empty catalyst can be found in $(p',q')$.

\begin{definition}[Active part of an action]
  Given a pair of logical states $(p, q)$, its \emph{active part}
  $\updateFP{p,q}$ is defined as the pair $(p', q')$ such that:
  \[
  \E c p = p' \composeL c /| q = q' \composeL c /| \V{c'} c'\leq p' /|
  c'\leq q' => c' = \unitL
  \]
\end{definition}

For instance, the interpretations of the actions associated with token
$\token a_{\li{x}}$ in the previous section all have the same active
parts
$(([x:v],\emptyset),\emptyset),(([x:v+1],\emptyset),\emptyset)$. Their
catalysts are either of the form $([z:v],\emptyset),\emptyset)$ (in
the interpretations of $I$, $I_{\li{x}}$, and $I_{\li{z}}$) or
$([y:v,z:v],\emptyset),\emptyset)$ (for $I_{\li{y}}$).

\begin{definition}[Action confinement]
  An action $a$ is \emph{confined} to a logical state $g$, written
  $g\containI a$, if
  \[
  \m{fst}(a)\meetL g \neq\emptyset => \m{fst}(\updateFP{a})\leq g
  \]
\end{definition}

Note that only the \emph{active} precondition of $a$, \textit{i.e.}
the part actually mutated by the action, has to be contained in $g$.
The condition we will require on actions with respect to the global
shared world $g$ is that all possible \emph{futures} of $g$ according
to the action models contain the actions. We start by defining the
effect of actions on the shared state.

\begin{definition}[Action application]
  The \emph{application} $a[l]$ of an action $a$ on a logical state
  $l$ is defined provided that there is $l'$ such that
  \[
    \m{fst}(a) \meetL l /=\emptyset /|
    l = \m{fst}(\updateFP{a}) \composeL l' /|
    \m{snd}(\updateFP{a})\compatL l'
  \]
  When that is the case, we write $a[l]$ for
  $\m{snd}(\updateFP{a})\composeL l'$. We write $\m{enabled}(a,l)$ to
  say that $a[l]$ is defined.
\end{definition}

In particular, this piece of the active precondition may be empty. In
that case, we find that we do not need to take the action into account
when considering the effect of all actions on the shared state, even
though it can be currently enabled. We thus introduce the following
notion of \emph{visible actions}.

\begin{definition}[Visible actions]
  An action $a$ is called \emph{visible in $l$}, written
  $\m{visible}(a,l)$ when
  \[
  \E{l'} \m{fst}(\updateFP{a})\meetL l = l' /| l'/=\unitL
  \]
\end{definition}

We are now ready to define our confinement condition on actions.
Inspired by the LRG logic~\cite{lrg}, we introduce the concept of
locally fenced action models to capture all possible states reachable
from the current state. A set of states $\fence{}$ \emph{fences} an
action model if it is invariant under interferences perpetrated by the
corresponding actions. We write $\m{rg}(f)$ to denote the \emph{range}
(or codomain) of a function $f$.

\begin{definition}[Locally-fenced action model]
  An action model $\lmod \in \AMods$ is \emph{locally fenced} by
  $\fence{} \in \pset{\LStates}$, written $\fence{} \strictfences \lmod$,
  if, for all $l \in \fence{}$ and all $a\in\m{rg}(\lmod)$,
\[
\begin{array}{L}
  l\containI a /|
  (\m{enabled}(a,l) /| \m{visible}(a,l) => a[l]\in\fence{})
\end{array}
\]
\end{definition}

\begin{definition}[Action model containment]
  An action model $\lmod$ is \emph{contained} by a logical state
  $l$, written $l\containI\lmod$, if there exists a fence $\fence{}$
  such that $l\in\fence{}$ and $\fence{}\strictfences{}\lmod$.
\end{definition}



A world $(l,g,\lmod,\gmod)$ is well-formed if $l$ and $g$
are compatible, the capabilities found in $l\composeL g$ exist in
the action models, actions in the global action model correspond to
actions in $\gmod$, and $\gmod$ is contained by $g$.

\begin{definition}[Well-formedness]
  A 4-tuple $(l, g, \lmod, \gmod)$ is \emph{well-formed},
  written $\wf{(l, g, \lmod, \gmod)}$, if
  \[
  \begin{array}{L}
    (\exsts{h,\ca{}}
    l \composeL g = (h,\ca{}) \land \ca{}\subseteq \dom{\lmod})
    /|\null\\
    (\V{\ca{}}\V{a\in\gmod(\ca{})}\E{a'\in\lmod(\ca{})}
    \updateFP{a} = \updateFP{a'}) /| l\containI \gmod
  \end{array}
  \]
\end{definition}

Note that we also have that $l\containI \lmod$.

\begin{definition}[Worlds]
  \label{def:worlds}
  The set of \emph{worlds} is defined as
  \begin{mathpar}
    \Worlds \eqdef \{w\in
    \LStates\times\LStates\times\AMods\times\AMods ||| \p{wf}(w)\}
  \end{mathpar}
  The \emph{composition} $\composeW$ between worlds is defined as
  \begin{align*}
    &\qquad (l,g,\lmod,\gmod) \composeW
    (l',g',\lmod',\gmod') \\
    &\eqdef
    \begin{cases}
      (l\composeL l', g, \lmod, \gmod) &
      \begin{array}[t]{L}
        \text{if }
        g = g' \text{, }
        \lmod = \lmod' \text{, and } \gmod = \gmod'\\[-.7ex]
        \text{and }\p{wf}((l\composeL l', g, \lmod, \gmod))
      \end{array}\\
      \textit{undefined}&\text{otherwise}
    \end{cases}
  \end{align*}
\end{definition}

The set of worlds with composition $\composeW$ forms a separation
algebra with multiple units, which are all the well-formed states of
the form $(\unitL,g,\lmod,\gmod)$.


\subsection{Assertions}
\label{sec:assertions}

Our assertions extend standard separation logic with \emph{subjective
  views}, as introduced in the previous section. \colosl is parametric
with respect to the heap and capability assertions and can be
instantiated with any assertion language over states $\Heaps$ and
capabilities $\Caps$. Here, we instantiate these languages for our
particular instantiation with respect to our model. We assume infinite
disjoint sets $\set{PVar}$, $\set{LVar}$, and $\set{Token}$ of program
variables, logical variables, and tokens, respectively.

\begin{definition}[Assertion syntax]
  \label{def:assertions}
  The assertions of \colosl are elements of $\Assertions$ described by
  the grammar below, where $\li x$ ranges over program variables, $x$
  over logical variables, and $\token a$ over tokens.
  \begin{align*}
    E &::= x ||| 0, 1, \ldots ||| E_1 + E_2 ||| \cdots
    \qquad\qquad
    K ::= a ||| K * K\\
    A &::=\m{false} \mid E_1 = E_2 ||| \emp ||| \li{x}|-> E |||
    E_1 |-> E_2 \mid [K] \\
    P, Q  &::= 
    A \mid P \Rightarrow Q \mid \exsts{x} P \mid
     P * Q \mid P --* Q \mid P \sepish Q% \mid P \intersect Q
     \mid \shared{P}{I} \\
    I &::= \emptyset ||| \interAss{K}{\vec{y}}{P}{Q}, I
  \end{align*}
\end{definition}

This syntax follows from standard separation logic with variables as
resource~\cite{entcs06} (notice that expressions $E$ do not allow
program variables), with the exception of shared-state assertions
$\shared P I$, which states that a subjective view satisfying $P$ and
undergoing interferences $I$ can be found in the global shared
state. $\emp$ is true of the units of $\composeW$. The predicates are
interpreted over the logic state of a world: $\li{x}|-> E$
(resp.\ $E_1|->E_2$) is true of the singleton stack (resp.\ heap)
where only \li{x} (resp.\ address $E_1$) is allocated and has value
$E$ (resp.\ points to $E_2$); capability assertions $[K]$ describe the
capability component of the local state: $\token a$ is true of the
singleton $\{a\}$, while the $*$ of capabilities is their disjoint
union; the spatial connectives $*$ and $--*$ are standard in
separation logic~\cite{rey02}, and $P**Q$ is the \emph{overlapping
  conjunction}, which states that the world can be split into three
disjoint sub-worlds, where the first two satisfy $P$ and the last two
satisfy $Q$~\cite{rey-slnotes}; classical predicates and connectives
have their standard classical meaning. Interference assertions $I$
describe actions enabled by a given capability, in the form of a pre
and post-condition.

%% , and spatial predicates and connectives
%% have been informally introduced in the previous section

The semantics of \colosl assertions is given by a forcing relation
$w,\lenv|= P$ between a world $w$, an interpretation of logical
variables $\lenv\in\LEnv == \set{LVar} --> \set{Val}$ and a formula
$P$. We use three auxiliary forcing relations. The first one
$\ca{},\lenv|=_K K$ interprets capability assertions. The second one
$l,\lenv\slsat P$ interprets formulas $P$ in the usual separation
logic sense over a logical state $l$ (and ignores shared state
assertions). The third one $s,\lenv|=_{g,\lmod,\gmod} P$ interprets
assertions over a \emph{subjective view} $s$ that is part of the
global shared state $g$, subject to action models $\lmod$ and
$\gmod$. This third form of satisfaction is needed to deal with
nesting of boxed formulas.\footnote{This presentation with several
  forcing relations differs from the usual CAP
  presentation~\cite{cap-ecoop10}, where formulas are interpreted over
  worlds that are not necessarily well-formed, and then cut down to
  well-formed ones. We found that the CAP presentation strays away
  from separation logic models in some ways. For instance, in CAP, $*$
  and $--*$ and not adjoints of each other; they are in our
  presentation.}

Moreover, since logical connectives are interpreted uniformly in all
cases, we write $|=_\dagger$ for either of the three satisfaction
relations, and then write $u$ for elements of either $\Worlds$ or
$\LStates$, and $\gray$ for either $\composeW$ or $\composeL$,
depending on whether the satisfaction relation is
$|=$, or either $\slsat$ or $|=_{l,\lmod,\gmod}$,
respectively.

\begin{definition}[Assertion semantics]
  Given a logical environment $\lenv$, the semantics of \colosl
  assertions is as follows, where $\semI[(.)]{.}: \LEnv --> \AMods$
  denotes the semantics of interference assertions:
\[
\begin{array}{R>{\null}l@{\ \,}c@{\ \,}l}
  \ca{},\lenv &|=_K \token a
  &\text{iff}& \ca{} = \{\token a\}\\
  \ca{},\lenv &|=_K K_1 * K_2
  &\text{iff}& \E{\ca{1},\ca{2}} \ca{} = \ca{1}\uplus\ca{2} /|\null\\
  &&& \ca{1},\lenv|=_K K_1 /| \ca{2}|=_K K_2\\
  l,\lenv &\slsat E_1 = E_2
  &\text{iff}& [|E_1|]_{\lenv} = [|E_2|]_{\lenv}\\
  l, \lenv &\slsat \li{x}|->E
  &\text{iff}&
  l =
  ([\li x: [|E|]_{\lenv}],\unitH,\unitCap)\\
  l, \lenv &\slsat E_1|->E_2 
  &\text{iff}&
  l =
  (\emptyset,[[|E_1|]_{\lenv}: [|E_2|]_{\lenv}],\unitCap)\\
  l, \lenv &\slsat [K]
  &\text{iff}&
  l = (\emptyset,\unitH, \ca{}) /| \ca{},\lenv|=_K K\\
%  &&\cdots\\
  l,\lenv &\slsat \m{false}
  && \text{never}\\
  l, \lenv &\slsat \emp &\text{iff}&   l, \lenv \slsat \shared P I
  \text{ iff } l = \unitL\\
  s, \lenv &|=_{g,\lmod,\gmod} A &\text{iff}& s, \lenv \slsat A\\
  s, \lenv &|=_{g,\lmod,\gmod} \shared P I &\text{iff}&
  (s,g,\lmod,\gmod), \lenv |= \shared P I\\
  u,\lenv &|=_\dagger P => Q
  &\text{iff}& u,\lenv |=_\dagger P\text{ implies }u,\lenv |=_\dagger Q\\
  u,\lenv &|=_\dagger \exsts x P
  &\text{iff}& \exsts v u, [\lenv|||x:v] |=_\dagger P\\
  u, \lenv &|=_\dagger P_1 * P_2 &\text{iff}&
  \exsts{u_1,u_2} u = u_1\gray u_2\text{ and}\\
  &&& u_1, \lenv |=_\dagger P_1 \text{ and }u_2, \lenv |=_\dagger P_2\\
  u, \lenv &|=_\dagger P --* Q &\text{iff}&
  \for{u'} u', \lenv |=_\dagger P \text{ and }
  u \sharp u'\\
  &&&\text{ implies }u\gray u', \lenv |=_\dagger Q\\
  u, \lenv &|=_\dagger P_1 ** P_2 &\text{iff}&
  \exsts{u',u_1,u_2} u = u'\gray u_1\gray u_2\text{ and}\\
  &&&
  u'\gray u_1, \lenv |=_\dagger P_1 \text{ and }
  u'\gray u_2, \lenv |=_\dagger P_2
\end{array}
\]
\[
\begin{array}{R>{\null}l@{\ \,}c@{\ \,}l}
  (l,g,\lmod,\gmod), \lenv &|= A &\text{iff}& l,\lenv \slsat A\\
  (l,g,\lmod,\gmod), \lenv &|= \shared P I &\text{iff}&
  l = \unitH\text{ and }
  \exsts{s,r}
  g = s\composeL r
  \text{ and}\\
  &&&s, \lenv |=_{g,\lmod,\gmod} P\text{ and }
  \extendsAM{\lmod, \gmod}{s}{r}{\semI[\lenv]{I}}
\end{array}
\]
\vspace{-1em}
\begin{align*}
  \semI[\lenv]{I}(\ca{}) &==
  \left\{
  \begin{array}{@{}l@{\ }|@{\ }r@{}}
    (p,q)&
    \begin{array}{@{}l@{}}
      \interAss{\ca{}}{\vec{y}}{P}{Q} \in I /|\null\\
      \exsts{\vec{v}}
      p,[\lenv|||\vec y:\vec v] \slsat P \land
      q,[\lenv|||\vec y:\vec v] \slsat Q
    \end{array}
  \end{array}
  \right\}
  \end{align*}
\end{definition}


The semantics of separation logic predicates and connectives is
standard and depends only on the local state.  $\shared{P}{I}$ states
that $P$ holds for only a sub-state $s$ of the global shared state
$s\composeL r$. The interference associated with $s$ is given by
interference assertion $\semI[\lenv]{I}$ such that the global and
local action models $\lmod$ and $\gmod$ are \emph{closed}
under $\semI[\lenv]{I}$ with respect to the subjective view $s$ and
context $r$. This will be formalised just after this lemma.
%Since shared state assertions are partial subjective description of the shared state, separating conjunction between them behaves as overlapping conjunction 

\begin{lemma}
  \label{lem:assertionFacts}
  The following formulas are valid according to the semantics above
  (where $x$ does not appear free in $I$):
  \begin{align*}
    \shared{P * \shared{Q}{I'}}{I} &<=> \shared{P}{I} *
    \shared{Q}{I'}&
    \E x \shared P I &<=>\shared{\E x P} I\\
    (P => Q) &=> \shared{P}{I} => \shared{Q}{I}&
    \shared{P}{I} &=> \emp
  \end{align*}
\end{lemma}
\begin{proof}
  Immediate.
\end{proof}





%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\paragraph{Action model closure}
\label{subsec:amodClosure}


It is typically composed of the subjective view $s$ of the thread
(\textit{e.g.}  variables \li x and \li y for $\mathbb{P}_{\li y}$)
together with a disjoint \emph{context} representing parts of the
shared state not currently visible to that thread (variable \li z).

from the interference relation of the subjective view of the
\emph{current} thread, extrapolated to act on the whole shared
state. In particular, actions in the global model always have a local
counterpart, but the converse does not hold in general: the global
action model may discard actions that are never possible, or that do
not influence the subjective view of the thread. The global action
model allows us to combine the knowledge of different subjective
views, as well as to know which sets of worlds are stable under
interferences from other threads; in particular, the rely and
guarantee relations will be computed from actions in the global action
model. The local action model ensures that different threads agree on
the set of all possible actions (but whether an action is actually
relevant to a given world is given by the global action model).
%% In doing so, it is allowed to forget about actions that are
%% equivalent, or that do not affect the subjective state. This leads to
%% a rather subtle notion of \emph{action closure} which is only needed
%% when defining the semantics of formulas (see \S TODO).


As expressed in the definition of the composition $\composeW$ between
worlds, different threads may have different subjective views, but
must agree on the overall shared state $g = s \composeW r$.  The
need for two action models in each world, a global one $\lmod$ and a
local one $\gmod$, arises from this decomposition of the shared
state between the subjective view and the context. The local action
model corresponds to actions as seen by the subjective view $s$, while
the global action model describes the effect of these actions on the
whole shared state $g$. Crucially, given a shared state assertion
$\shared P I$, $\gmod$ must contain all actions specified by
$I$, while $\lmod$ is allowed to be any set of actions which have
the same effect on the subjective state. In particular, it may be the
case that some actions are irrelevant to the subjective view and thus
omitted from the global action model. We must nonetheless record
\emph{all} actions in the local action model to ensure consistency in
the event that some thread has extended the shared state (using
\eqref{eq:extend}). More precisely, we will require that $(\lmod,
\gmod)$ be \emph{closed} with respect to $I$ and the
decomposition $s$, $r$.

Interference assertions are interpreted into localised action models
from which global action models are then calculated over the entire
shared state. When computing the effect of a local action $(p,q)$ over
all possible shared states, a naÃ¯ve approach to would be to simply
``frame on'' arbitrary pieces of state $r$ to yield $(p\composeL r,
q\composeL r)$.  However, the situation is more complex than this,
since the global semantics of local actions depends on the current
subjective view. To see why, consider the following example.

\begin{example}[]\label{ex:closure}
  Let $P \eqdef \shared{\cell{y}{2} \lor \cell{z}{3}}{I} *
  \shared{\cell{y}{2}}{\emptyset}$ denote the subjective view of the
  current thread of the shared state with $I \eqdef (\token{a}:
  \left\{\cell{x}{1} * \cell{y}{2} \swap \cell{x}{2}\right\})$. The
  action $\token{a}$ states that if the shared state contains the
  resource $\cell{x}{1} * \cell{y}{2}$, then a thread in possession of
  the $[\token{a}]$ capability can update the value of $x$ such that
  $\cell{x}{2}$ and claim the $\cell{y}{2}$ resource by moving it into
  its local state. On the other hand, $\cell{y}{2}$ is an immutable
  shared resource since its associated interference corresponds to
  $\emptyset$.

  In calculating the semantics of $P$, we need to find a global action
  model $\lmod$ that would encompass the behaviour of actions in $I
  \cup \emptyset$. A na\"\i ve attempt at calculating $\lmod$ would
  be to define it such that $\lmod(\{\token a\}) =
  \left\{(\cell{x}{1} \composeL \cell{y}{2} \composeL r, \cell{x}{2}
  \composeL r ) \mid r \in \LStates \right\}$. That is, given the
  localised behaviour of $\{\token a\}$ as prescribed in
  $\semI[\lenv]{I}$, we extend it with arbitrary logical states so
  that if the shared state contains the $\cell{x}{1} \composeL
  \cell{y}{2}$ resource, regardless of the rest of the shared state
  ($r$), the action can be carried out accordingly while leaving $r$
  untouched. Since the shared state currently contains the
  $\cell{y}{2}$ resource, with this interpretation when the shared
  state also contains $\cell{x}{1}$, it is possible to perform the
  action \token{a} and remove $\cell{y}{2}$ from the shared
  state. However, this does not agree with the current view, since as
  explained above $\cell{y}{2}$ is an immutable shared resource that
  cannot be removed from the shared state.
%in exchange for $\cell{w}{4}$. Since the current thread holds the $\cell{y}{2}$ resource locally, it extends the shared state with this resource such that its subjective view is captured by $P' \eqdef \shared{\cell{x}{1} * \cell{z}{3}}{I} * \shared{\cell{y}{2}}{\emptyset}$. With this simple extension, $\cell{y}{2}$ is now an immutable shared resource since its associated interference corresponds to $\emptyset$.
%Given a logical environment $\lenv$, let $\ca{} \in \semK[\lenv]{\token{X}}$. In calculating the semantics of $P$, we need to find a global action model $\lmod$ that would encompass the behaviour of actions in $I \cup \emptyset$. A na\"\i ve attempt at calculating $\lmod$ would be to define it such that $\lmod(\ca{}) = \left\{(\cell{x}{1} \composeL \cell{y}{2} \composeL r, \cell{x}{2} \composeL \cell{w}{4} \composeL r ) \mid r \in \LStates \right\}$. That is, given the localised behaviour of $\ca{}$ as prescribed in $\semI[\lenv]{I}$, we extend it with arbitrary logical states so that if the shared state contains the $\cell{x}{1} \composeL \cell{y}{2}$ resource, regardless of the rest of the shared state ($r$), the action can be carried out accordingly while leaving $r$ untouched. With this interpretation,  
\end{example}

The solution is to take the subjective view of the shared state into
account when extrapolating the global effects of local actions. Thus,
we revisit our definition of action application to account for the
fact that actions act on both a subjective state and a context.

\begin{definition}[Action application (cont.)]
  The application of action $a$ on the subjective state $s$ together
  with the context $r$, written $a[s,r]$, is defined
  provided that there are $s'$ and $r'$ such that
  \[
  \begin{array}{L}
  \m{fst}(a)\meetL (s\composeL r) /= \emptyset /|
  \E{p_s,p_r}
  s = p_s \composeL s' /|
  r = p_r \composeL r' /|\null\\
  \quad
  \m{fst}(\updateFP{a}) = p_s\composeL p_r /|
  \m{snd}(\updateFP{a})\composeL s'\composeL r'\text{ is defined}\\
  \end{array}
  \]
  When that is the case, we write $a[s,r]$ for
  $(\m{snd}(\updateFP{a})\composeL s',r')$.
\end{definition}

Actions in the interpretation of the interference relation associated
with a subjective view should account for all the enabled and visible
actions present in the local action model. This is captured by the
following definition.

\begin{definition}
  An action $a$ is \emph{present} in a set of actions $A$ from a state
  $l$, written $\m{present}(a,l,A)$, if
  \[
  \V r \m{fst}(a)\leq l\composeL r =>
  \E{a'\in A} \updateFP{a'} = \updateFP{a} /| \m{fst}(a')\leq
  l\composeL r
  \]
\end{definition}



%%  More precisely, given $\shared{P}{I}$, the contents of the shared
%% state are of the form $l \composeL r$ where $l$ denotes a
%% subjective view as captured by $P$ while $r$ represents the context
%% or parts of the shared state not visible by the subjective view. In
%% order to remedy the problem illustrated in \ex~\ref{ex:closure},
%% when calculating the global behaviour of actions, rather than
%% extending their localised behaviour with arbitrary frames, we
%% relate them to the current subjective view $l$ and the context
%% $r$. This is captured by the \emph{closure} relation as defined
%% below.


%\begin{example}[]\label{ex:closure}
%Let $\tau_1$ and $\tau_2$ denote two distinct threads with $P \eqdef \token{X} * \cell{w}{4} * \shared{\cell{x}{1} * \cell{y}{2} \;\lor\; \cell{x}{1} * \cell{z}{3}}{I}$ and $Q \eqdef \cell{y}{2} * \shared{\cell{x}{1} * \cell{z}{3}}{I}$ as their subjective views of the shared state respectively with $I \eqdef (\token{X}: \left\{\cell{x}{1} * \cell{y}{2} \swap \cell{x}{1} * \cell{w}{4}\right\})$. The action associated with $\token{X}$ states that if the shared state contains the resource $\cell{x}{1} * \cell{y}{2}$, then an action in possession of the $\cell{w}{4}$ resource can claim the $\cell{y}{2}$ resource in exchange for $\cell{w}{4}$. Given a logical environment $\lenv$, let $\ca{} \in \semK[\lenv]{\token{X}}$ and $\lmod$ denote the global interpretation of $I$. A naive attempt at calculating $\lmod$ would be to define it such that $\lmod(\ca{}) = \left\{(\cell{x}{1} \composeL \cell{y}{2} \composeL r, \cell{x}{1} \composeL \cell{w}{4} \composeL r ) \mid r \in \LStates \right\}$
%Since $\tau_2$ holds the $\cell{y}{2}$ resource locally, Suppose that at this point the current thread extends the shared state with 
%\end{example}


\begin{definition}[Action model closure]
  A pair $(\lmod, \gmod)$ of action models is \emph{closed}
  under a subjective state $s$, context $r$, and action model
  $\lmod'$, written $\extendsAM{\lmod,
    \gmod}{s}{r}{\lmod'}$, if $\lmod' \subseteq \gmod$
  and $\extendsAMUpto{\lmod, \gmod}{n}{s}{r}{\lmod'}$ for
  all $n\in\Nats$, where $\downarrow_n$ is defined recursively as
  follows:
\[
\begin{array}{L}
  \extendsAMUpto{\lmod, \gmod}{\mathrlap{0}\phantom{n}}{s}{r}{\lmod'} \iffdef
  \m{true}\\
  \extendsAMUpto{\lmod, \gmod}{n+1}{s}{r}{\lmod'} \iffdef\\
  \V{\ca{}}\V{a\in \lmod'(\ca{})}
  \m{enabled}(a,s\composeL r) =>\null\\
  \quad\extendsAMUpto{\lmod, \gmod}{n}{\m{fst}(a[s,r])}{\m{snd}(a[s,r])}{\lmod'} \land\null\\
  \quad\m{fst}(a)\leq s\composeL r => (s\composeL r,
  \m{fst}(a[s,r])\composeL \m{snd}(a[s,r]))\in \lmod(\ca{})
  /|\null\\
  \V{\ca{}}\V{a\in \gmod(\ca{})}
  \m{enabled}(a,s\composeL r) =>\null\\
  \quad\m{present}(a,s\composeL r,\lmod'(\ca{}) |/\null\\
  \quad(\neg\m{visible}(a,s) /| \m{fst}(a[s,r]) = s /|
  \extendsAMUpto{\lmod, \gmod}{n}{s}{\m{snd}(a[s,r])}{\lmod'})
  %% \hspace*{0.1cm}\for{\ca{}, l', r', t, p, q, p', q', p_l, p_r}\\
  %% \hspace*{0.2cm}(p, q) \in \lmod'(\ca{}) 
  %% \land \updateFP{p, q} = (p', q')
  %% \land p \leq  l \composeL r \composeL t \land\null\\
  %% \hspace*{0.2cm}p' = p_l \composeL p_r 
  %% \land p' \maxMeetL l = p_l 
  %% \land l = p_l \composeL l' 
  %% \land r = p_r \composeL r' =>\\
  %% \hspace*{0.4cm} \extendsAMUpto{\lmod, \gmod}{n}{q' \composeL l'}{r'}{\lmod'} \land\null\\
  %% \hspace*{0.4cm}t = \unitL => 
  %% \left(
  %% \begin{array}{l}
  %%   (p' \composeL l' \composeL r', q' \composeL l' \composeL r') \in \lmod(\ca{})\\
  %%   \lor\; q' \composeL l' \composeL r' \text{ is undefined} 
  %% \end{array}
  %% \right)\\
  %% \hspace*{2cm} \land\\
  %% \hspace*{0.1cm}\for{\ca{}, p, q, p', q', l', r'} \\
  %% \hspace*{0.2cm} (p, q) \in \gmod(\ca{})
  %% \land \updateFP{p, q} = (p', q')
  %% \land p \composeL l' = l \composeL r \composeL r' =>\\
  %% \hspace*{0.4cm}\exsts{f, c'} (p' \composeL f, q' \composeL f) \in \lmod'(\ca{}) \land p' \composeL f \composeL c' =  l \composeL r \composeL r' \;\;\lor\\
  %% \hspace*{0.4cm}q \composeL l' \text{ is undefined} \;\;\lor\\
  %% \hspace*{0.4cm}p' \maxMeetL l = \unitL \land \exsts{r''} q \composeL l' = l \composeL r' \composeL r'' \land \extendsAMUpto{\lmod, \gmod}{n}{l}{r''}{\lmod'}
\end{array}
\]
\end{definition}

\julescomment{TODO: update description, add diagrams.}

The above states that the $(\lmod, \gmod)$ pair is closed under $(s, r, \lmod')$ if the closure relation holds for any number of steps $n \in \Nats$ where 1) $s$ denotes the subjective view of the shared state, 2) $r$ denotes the context, 3) $s \composeL r$ captures the entire shared state  and 4) a step corresponds to the occurrence of an action as prescribed in either the current action model $\lmod'$ or $\gmod$. The relation is satisfied trivially for no steps ($n = 0$). On the other hand, for an arbitrary $n\in \Nats$ the relation holds iff:
\begin{enumerate}
	\item Given a capability $\ca{}$, its action $(p, q) \in \lmod'(\ca{})$ and its update footprint $(p', q')$, if the action precondition $p$ is satisfiable through an arbitrary extension of the shared region ($t$), then after one step the closure relation holds for the resultant subjective state $q' \composeL s'$ and context $r'$ where $s'$ and $r'$ capture the residue subjective and context states, respectively; that is parts of the states unchanged by the action. Moreover, if the action requires no extension ($t = \unitL$) and thus the action precondition is satisfied by the current shared state $s \composeL r$, then the action should be included in the global action model $\lmod$ unless the resultant state $q' \composeL s' \composeL r'$ is undefined.
	
	\item Given a capability $\ca{}$, its action $(p, q) \in \gmod$ and its update footprint $(p', q')$, if the action precondition is satisfiable by the current shared state then \emph{either} 1) a similar action is visible to $\lmod'$, \emph{or} 2) the resultant state is undefined and thus the action can never take place, \emph{or} 3) the subjective state remains unchanged by the action $(p' \maxMeetL s = \unitL )$ and after one step the closure relation holds for the subjective state $s$ and the resultant context $r'$.
\end{enumerate}
Intuitively, the closure relation ensures that given the current subjective state $s$ and context $r$, all possible actions of $\lmod'$ are reflected in the global action model $\lmod$ \emph{and} for all actions that are possible and are yet unbeknownst to $\lmod'$, the subjective view $s$ remains unaffected.

As illustrated above, the global behaviour $\lmod$ relies on the division between the subjective state $s$ and the context $r$. As such, it is essential to calculate it upon defining the semantics of $\shared{P}{I}$ when the boundary between the subjective state described by $P$ and the context is discernible.  In other words, we cannot correctly identify the global action model associated with  a shared state $s$ and a localised action model $\gmod$ without knowledge of the division between the subjective state and the context. 



\begin{lemma}\label{lem:semprinciples}
The logic implications \eqref{eq:forget}, \eqref{eq:split}, and \eqref{eq:merge} are \emph{valid}.
%
\begin{proof}
The case of \eqref{eq:split} is straightforward from the semantics of assertions.
For \eqref{eq:forget}, it suffices to show that the global and local action model pair is closed under the smaller subjective view while for \eqref{eq:merge} we need to show that the action model pair is closed under the combined subjective view. The full proof is provided in~\cite{colosl-tr14}.
\renewcommand{\qed}{}
%
\end{proof}
%
\end{lemma}



\paragraph{On the need for local and global action models}
\label{subsec:localGlobalActionModels}

Recall that a shared state assertion $\shared{R}{I}$ subjectively describes parts of the shared state that satisfy $R$. On the other hand, an action of the form $P \swap Q$ specified in $I$ captures the behaviour of the associated update in a \emph{localised} manner. That is, if \emph{parts} of the shared state satisfy the action precondition $P$, after the execution of the action, the shared state is mutated such that the said parts satisfy the action postcondition $Q$ and the rest of the shared state remains unchanged. As such, we interpret interference assertions over the entire shared state; however as we illustrate with the following example, recording the global interpretation of actions alone in the underlying model is not enough as the ways in which the shared state can be updated may vary with its extension. 
\begin{example}[]Let $P \eqdef \cell{w}{1} * \shared{\cell{x}{2}}{I}$ denote the view of the current thread with $I \eqdef \left(\token{a}: \left\{\cell{x}{2} * \cell{w}{1} \swap \cell{x}{3} * \cell{w}{1}\right\}\right)$. The action \token{a} states that if the shared state contains the resource $\cell{x}{2} * \cell{w}{1}$, then the value of $x$ may be mutated such that $\cell{x}{3}$ while $w$ as well as other parts of the shared state remain unchanged. Given a logical environment $\lenv$, let $\lmod_0 = \semI[\lenv]{I}$ denote the localised interpretation of $I$ (\defin\ref{def:interferenceSemantics}); and $\ca{\token{a}} \in  \semK[\lenv]{\token{a}}$ represent a capability captured by the assertion $[\token{a}]$. In calculating the semantics of $P$, we need to interpret the behaviour of actions specified in $I$ over the entire shared state.

Since the current thread locally holds the $\cell{w}{1}$ resource and the contents of thread-local and shared states are always disjoint, we can safely deduce that $\cell{w}{2}$ is not a part of the shared state. Consequently, the action associated with $\ca{\textsf{X}}$ cannot be carried out by either the current thread or the environment; thus any $\lmod'$ where $\lmod'(\ca{\textsf{X}}) = \emptyset$, yields a valid extension of $\lmod_0$ to the entire shared state.

Suppose at this point the current thread extends the shared state with the $\cell{w}{1}$ resource such that $\shared{\cell{x}{2}}{I} * \shared{\cell{w}{1}}{\emptyset}$ denotes its current view. Since the shared state now contains both $\cell{x}{2}$ and $\cell{w}{1}$ resources, it should be possible for a thread in possession of $[\token{a}]$ to perform the associated action. However, this is not reflected in the global interpretation $\lmod'$ and hence $\lmod'$ needs to be recalculated upon extension of the shared state. On the other hand, from $\lmod'$ alone and without keeping track of the localised interpretation $\lmod_0$, we cannot recalculate the global behaviour since $\lmod'$ is lossy and does not reflect the original behaviour prescribed to $\ca{\textsf{X}}$.
\end{example}
As demonstrated by the above example, it is necessary to record the localised interpretation of interference assertions at the model level. As a result, given a world $(l, g, \lmod, \gmod)$, the third component $(\lmod)$ denotes the global behaviour of actions while the fourth component $(\gmod)$ represents the set of all localised action behaviour.
On the other hand, it may seem sufficient for the model to track the localised action behaviour $(\gmod)$ alone as the global behaviour can be calculated from the localised one. However, as we illustrate in \S\ref{subsec:amodClosure}, calculation of the global behaviour depends on the subjective view of the shared state and the context (parts of the shared state not visible) as well as the localised action behaviour. As a result, given $\lenv \in \LEnv$, when defining the semantics of a subjective shared assertion $\shared{P}{I}$, we calculate the global behaviour based on the subjective view as prescribed by $P$, the localised behaviour $\semI[\lenv]{I}$ and the choice of compatible contexts. 

We lift the notion of fences and local fences to
assertions as follows, given $\fenceAss{} \in \Assertions$ and $I \in
\IAssertions$:
\begin{align*}
  \fenceAss{} \fences I &\iffdef \for{\lenv,\ca{}}
  \{ l \mid l, \lenv \slsat F \} \fences \semI[\lenv]{I}(\ca{})\\
  \fenceAss{} \strictfences I &\iffdef \for{s,\lenv,\ca{}}
  \{ l \mid l, \lenv \slsat F \} \strictfences \semI[\lenv]{I}(\ca{})
\end{align*}
